# Simple workflow for deploying static content (main + dev åˆ†ç¦»éƒ¨ç½²ï¼Œè§£å†³ç¯å¢ƒä¿æŠ¤è§„åˆ™æŠ¥é”™)
name: Deploy static content (main + dev isolation - fix env protection)

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:

# æƒé™é…ç½®ï¼šæ»¡è¶³æ‰€æœ‰åˆ†æ”¯çš„æ“ä½œéœ€æ±‚
permissions:
  contents: write  # æ”¯æŒ dev åˆ†æ”¯å‘ main æ¨é€ï¼Œmain åˆ†æ”¯éƒ¨ç½² Pages
  pages: write     # ä»… main åˆ†æ”¯ä½¿ç”¨
  id-token: write  # ä»… main åˆ†æ”¯ä½¿ç”¨

# å¹¶å‘æ§åˆ¶ï¼šæŒ‰åˆ†æ”¯éš”ç¦»ï¼Œé¿å…äº’ç›¸å¹²æ‰°
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # ========== Job 1ï¼šä»…å¤„ç† main åˆ†æ”¯ï¼ˆæ­£å¼ç¯å¢ƒï¼Œå…³è” github-pages ç¯å¢ƒï¼‰ ==========
  deploy-main:
    if: github.ref == 'refs/heads/main'  # ä»… main åˆ†æ”¯æ‰§è¡Œ
    environment:
      name: github-pages  # ä»… main åˆ†æ”¯å…³è”è¯¥ç¯å¢ƒï¼Œç¬¦åˆä¿æŠ¤è§„åˆ™
      url: ${{ steps.main_deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify game files (main branch)
        run: |
          echo "ğŸ“ Checking main branch project structure..."
          required_files=("game.html" "index.html")
          required_dirs=("assets")

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file not found"
              exit 1
            fi
          done

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir directory exists"
            else
              echo "âŒ $dir directory not found"
              exit 1
            fi
          done

          # è‡ªåŠ¨åˆ›å»º .nojekyll æ–‡ä»¶
          if [ ! -f ".nojekyll" ]; then
            echo "ğŸ“Œ Creating .nojekyll file"
            touch .nojekyll
          else
            echo "âœ… .nojekyll file exists"
          fi

          echo "ğŸ® Main branch structure verified"

      - name: Setup GitHub Pages (main only)
        uses: actions/configure-pages@v5

      - name: Upload main branch artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy main branch to GitHub Pages
        id: main_deployment
        uses: actions/deploy-pages@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========== Job 2ï¼šä»…å¤„ç† dev åˆ†æ”¯ï¼ˆå¼€å‘ç¯å¢ƒï¼Œä¸å…³è”ä»»ä½•ç¯å¢ƒï¼‰ ==========
  deploy-dev:
    if: github.ref == 'refs/heads/dev'  # ä»… dev åˆ†æ”¯æ‰§è¡Œ
    runs-on: ubuntu-latest
    # å…³é”®ï¼šä¸é…ç½® environmentï¼Œå½»åº•è„±ç¦» github-pages ç¯å¢ƒï¼Œè§„é¿ä¿æŠ¤è§„åˆ™
    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify game files (dev branch)
        run: |
          echo "ğŸ“ Checking dev branch project structure..."
          required_files=("game.html" "index.html")
          required_dirs=("assets")

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file not found"
              exit 1
            fi
          done

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir directory exists"
            else
              echo "âŒ $dir directory not found"
              exit 1
            fi
          done

          # è‡ªåŠ¨åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆåŒæ­¥åˆ° main/dev/ ç›®å½•ï¼‰
          if [ ! -f ".nojekyll" ]; then
            echo "ğŸ“Œ Creating .nojekyll file"
            touch .nojekyll
          else
            echo "âœ… .nojekyll file exists"
          fi

          echo "ğŸ® Dev branch structure verified"

      - name: Dev branch - Deploy to main/dev/ directory
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: main
          folder: '.'
          target-folder: dev
          clean: true
          clean-exclude: |
            index.html
            game.html
            assets/
            .nojekyll
            README.md
          commit-message: "Auto deploy dev branch to main/dev/ [skip ci]"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          disable-jekyll: true