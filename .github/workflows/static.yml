# Simple workflow for deploying static content to GitHub Pages (main + dev åˆ†ç¦»éƒ¨ç½²)
name: Deploy static content (main + dev isolation)

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:

# æƒé™é…ç½®
permissions:
  contents: write  # éœ€æå‡æƒé™ï¼Œç”¨äºæ¨é€ dev åˆ†æ”¯äº§ç‰©åˆ° main åˆ†æ”¯çš„ dev/ ç›®å½•
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ï¼ˆæŒ‰åˆ†æ”¯éš”ç¦»ï¼Œé¿å…äº’ç›¸å¹²æ‰°ï¼‰
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œç”¨äºåˆ†æ”¯åŒæ­¥

      - name: Verify game files
        run: |
          echo "ğŸ“ Checking project structure..."
          required_files=("game.html" "index.html")
          required_dirs=("assets")

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file not found"
              exit 1
            fi
          done

          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir directory exists"
            else
              echo "âŒ $dir directory not found"
              exit 1
            fi
          done

          echo "ğŸ® Project structure verified"

      - name: Setup Pages (only for main branch)
        if: github.ref == 'refs/heads/main'  # ä»… main åˆ†æ”¯æ‰§è¡Œé»˜è®¤ Pages é…ç½®
        uses: actions/configure-pages@v5

      # ========== main åˆ†æ”¯ï¼šåŸæœ‰æ ¹ç›®å½•éƒ¨ç½²ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
      - name: Upload main branch artifact (root directory)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'  # æ ¹ç›®å½•ä¸Šä¼ 

      - name: Deploy main branch to GitHub Pages (root)
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4

      # ========== dev åˆ†æ”¯ï¼šéƒ¨ç½²åˆ° main åˆ†æ”¯çš„ dev/ å­ç›®å½• ==========
      - name: Deploy dev branch to main/dev/ directory
        if: github.ref == 'refs/heads/dev'  # ä»… dev åˆ†æ”¯æ‰§è¡Œæ­¤æ­¥éª¤
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: main  # æ¨é€åˆ° main åˆ†æ”¯
          folder: '.'  # dev åˆ†æ”¯çš„å½“å‰ç›®å½•ï¼ˆè¦éƒ¨ç½²çš„æ–‡ä»¶ï¼‰
          target-folder: dev  # æ¨é€åˆ° main åˆ†æ”¯çš„ dev/ å­ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
          clean: true  # æ¸…ç† dev/ ç›®å½•çš„æ—§æ–‡ä»¶ï¼ˆä¿æŒæœ€æ–°ï¼‰
          clean-exclude: |  # æ’é™¤ main åˆ†æ”¯æ ¹ç›®å½•çš„æ­£å¼æ–‡ä»¶ï¼Œé¿å…è¯¯åˆ 
            index.html
            game.html
            assets/
            .nojekyll
          commit-message: "Auto deploy dev branch to main/dev/ [skip ci]"  # æäº¤ä¿¡æ¯ï¼Œskip ci é¿å…è§¦å‘ main åˆ†æ”¯çš„é‡æ–°éƒ¨ç½²