<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ¢ç‰©å“</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body>
    <!-- ç§»åŠ¨ç«¯ä¿¡æ¯æŒ‰é’® -->
    <div id="mobile-info-btn" style="position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: #667eea; color: white; border: none; font-size: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1000; cursor: pointer; display: flex; align-items: center; justify-content: center;">ğŸ“¦</div>

    <!-- ç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿ -->
    <div id="mobile-info-panel" style="display: none; position: fixed; bottom: 80px; right: 20px; width: 250px; max-height: 300px; background: rgba(255, 255, 255, 0.98); border-radius: 10px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); z-index: 1000; padding: 15px; overflow-y: auto;">
        <!-- å†…å®¹ç”±JavaScriptåŠ¨æ€å¡«å…… -->
    </div>

    <!-- é®ç½©å±‚ -->
    <div id="mobile-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

    <!-- äº¤æ¢ç‰©å“å†…å®¹åŒºåŸŸ -->
    <div id="exchange-content">
        <!-- å†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="../assets/js/characters.js"></script>
    <script src="../assets/js/items.js"></script>
    <script src="../assets/js/itemStories.js"></script>
    <script>
        // ä»URLå‚æ•°è·å–ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const currentCharacter = urlParams.get('character') || 'claudius';
        const targetCharacter = urlParams.get('target') || 'chengying';
        const day = urlParams.get('day') || '1';

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            selectedCharacter: currentCharacter,
            currentDay: parseInt(day),
            gameStarted: true,
            playerInventory: [],
            allCharactersItems: {},
            npcs: [],
            exchangeCompleted: false // æ·»åŠ äº¤æ¢å®Œæˆæ ‡è®°
        };

        // ä»localStorageåŠ è½½æ¸¸æˆçŠ¶æ€
        function loadGameState() {
            const savedState = localStorage.getItem('qiyuanGameState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                gameState = { ...gameState, ...parsedState };
            } else {
                // åˆå§‹åŒ–é»˜è®¤ç‰©å“
                initDefaultItems();
            }
        }

        // åˆå§‹åŒ–é»˜è®¤ç‰©å“
        function initDefaultItems() {
            const char = window.characters[currentCharacter];
            const targetChar = window.characters[targetCharacter];

            gameState.playerInventory = [...char.initialItems];
            gameState.allCharactersItems = {};

            // ä¸ºæ‰€æœ‰è§’è‰²åˆå§‹åŒ–ç‰©å“
            Object.keys(window.characters).forEach(charId => {
                gameState.allCharactersItems[charId] = [...window.characters[charId].initialItems];
            });
        }

        // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°localStorage
        function saveGameState() {
            localStorage.setItem('qiyuanGameState', JSON.stringify(gameState));
        }

        // æ˜¾ç¤ºäº¤æ¢ç‰©å“é¡µé¢
        function showExchangePage() {
            const currentChar = window.characters[currentCharacter];
            const targetChar = window.characters[targetCharacter];

            const currentItems = gameState.allCharactersItems[currentCharacter] || [];
            const targetItems = gameState.allCharactersItems[targetCharacter] || [];

            const html = `
                <div class="page-container">
                    <h2>äº¤æ¢ç‰©å“</h2>

                    <div class="exchange-info-section">
                        <div class="character-info-large">
                            <h3>${currentChar.name} vs ${targetChar.name}</h3>
                            <p>é€‰æ‹©è¦äº¤æ¢çš„ç‰©å“ï¼Œç‚¹å‡»äº¤æ¢æŒ‰é’®å®Œæˆäº¤æ˜“</p>
                        </div>
                    </div>

                    <div class="exchange-section">
                        <h3>ä½ çš„ç‰©å“</h3>
                        <div class="items-grid">
                            ${currentItems.map((item, index) => `
                                <div class="exchange-item player-item" data-item="${item}" data-index="${index}" ${gameState.exchangeCompleted ? 'style="pointer-events: none; opacity: 0.7;"' : ''}>
                                    ${getItemDisplayName(item)}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="exchange-controls">
                        <button class="action-btn secondary" onclick="swapItems()" ${gameState.exchangeCompleted ? 'disabled' : ''} style="${gameState.exchangeCompleted ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ${gameState.exchangeCompleted ? 'äº¤æ¢å·²å®Œæˆ' : 'â‡„ äº¤æ¢ç‰©å“'}
                        </button>
                    </div>

                    <div class="exchange-section">
                        <h3>${targetChar.name}çš„ç‰©å“</h3>
                        <div class="items-grid">
                            ${targetItems.map((item, index) => `
                                <div class="exchange-item target-item" data-item="${item}" data-index="${index}" ${gameState.exchangeCompleted ? 'style="pointer-events: none; opacity: 0.7;"' : ''}>
                                    ${getItemDisplayName(item)}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="exchange-actions">
                        <button class="action-btn primary large" onclick="finishExchange()" ${!gameState.newlyAcquiredItem ? 'disabled' : ''} style="${!gameState.newlyAcquiredItem ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ç»§ç»­è°ƒæŸ¥
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('exchange-content').innerHTML = html;
            updateMobileInfoPanel();
            hideMobileInfoPanel();
        }

        // é€‰æ‹©ç‰©å“è¿›è¡Œäº¤æ¢
        let selectedPlayerItem = null;
        let selectedTargetItem = null;

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('player-item')) {
                // é€‰æ‹©ç©å®¶ç‰©å“
                document.querySelectorAll('.player-item').forEach(item => item.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedPlayerItem = e.target.dataset.item;
                checkSwapReady();
            } else if (e.target.classList.contains('target-item')) {
                // é€‰æ‹©ç›®æ ‡ç‰©å“
                document.querySelectorAll('.target-item').forEach(item => item.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedTargetItem = e.target.dataset.item;
                checkSwapReady();
            }
        });

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥äº¤æ¢
        function checkSwapReady() {
            // å¦‚æœäº¤æ¢å·²å®Œæˆï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            if (gameState.exchangeCompleted) {
                return;
            }
            
            const swapBtn = document.querySelector('.exchange-controls .action-btn');
            if (selectedPlayerItem && selectedTargetItem) {
                swapBtn.style.background = '#28a745';
                swapBtn.textContent = `â‡„ äº¤æ¢: ${getItemDisplayName(selectedPlayerItem)} â†” ${getItemDisplayName(selectedTargetItem)}`;
            } else {
                swapBtn.style.background = '';
                swapBtn.textContent = 'â‡„ äº¤æ¢ç‰©å“';
            }
        }

        // æ‰§è¡Œç‰©å“äº¤æ¢
        function swapItems() {
            if (!selectedPlayerItem || !selectedTargetItem) {
                alert('è¯·é€‰æ‹©è¦äº¤æ¢çš„ç‰©å“ï¼');
                return;
            }

            // æ‰§è¡Œäº¤æ¢
            const currentItems = gameState.allCharactersItems[currentCharacter];
            const targetItems = gameState.allCharactersItems[targetCharacter];

            const playerIndex = currentItems.indexOf(selectedPlayerItem);
            const targetIndex = targetItems.indexOf(selectedTargetItem);

            if (playerIndex !== -1 && targetIndex !== -1) {
                // è®°å½•æ–°è·å¾—çš„ç‰©å“
                const newItem = selectedTargetItem;

                // äº¤æ¢ç‰©å“
                [currentItems[playerIndex], targetItems[targetIndex]] = [targetItems[targetIndex], currentItems[playerIndex]];

                // æ›´æ–°ç©å®¶èƒŒåŒ…æ˜¾ç¤º
                gameState.playerInventory = [...currentItems];

                // è®°å½•æ–°è·å¾—çš„ç‰©å“åˆ°æ¸¸æˆçŠ¶æ€
                gameState.newlyAcquiredItem = newItem;

                // æ ‡è®°äº¤æ¢å·²å®Œæˆï¼Œåªèƒ½äº¤æ¢ä¸€æ¬¡
                gameState.exchangeCompleted = true;

                // ä¿å­˜çŠ¶æ€
                saveGameState();

                // é‡æ–°æ˜¾ç¤ºé¡µé¢
                showExchangePage();

                alert(`æˆåŠŸäº¤æ¢ç‰©å“ï¼\nä½ å¾—åˆ°äº†ï¼š${getItemDisplayName(selectedTargetItem)}\nå¯¹æ–¹å¾—åˆ°äº†ï¼š${getItemDisplayName(selectedPlayerItem)}`);

                // é‡ç½®é€‰æ‹©
                selectedPlayerItem = null;
                selectedTargetItem = null;
            }
        }

        // å®Œæˆäº¤æ¢ï¼Œè·³è½¬åˆ°ç‰©å“è¯¦æƒ…é¡µ
        function finishExchange() {
            // ä¿å­˜æœ€ç»ˆçŠ¶æ€
            saveGameState();

            // è·å–æ–°è·å¾—çš„ç‰©å“
            const newItem = gameState.newlyAcquiredItem;
            if (newItem) {
                // è·³è½¬åˆ°ç‰©å“è¯¦æƒ…é¡µ
                const itemDetailUrl = `../items/item-${encodeURIComponent(newItem)}.html?character=${currentCharacter}&day=${day}&from=exchange`;
                window.location.href = itemDetailUrl;
            } else {
                // å¦‚æœæ²¡æœ‰æ–°ç‰©å“ï¼Œç›´æ¥è¿”å›æ¸¸æˆ
                const gameUrl = `../game.html?character=${currentCharacter}&day=${day}&from=exchange`;
                window.location.href = gameUrl;
            }
        }

        // æ›´æ–°ç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿
        function updateMobileInfoPanel() {
            const isMobile = window.innerWidth <= 768;

            // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
            const mobileBtn = document.getElementById('mobile-info-btn');
            if (mobileBtn) {
                mobileBtn.style.display = (isMobile && gameState.gameStarted) ? 'flex' : 'none';
            }

            if (!isMobile || !gameState.gameStarted) {
                hideMobileInfoPanel();
                return;
            }

            const char = window.characters[gameState.selectedCharacter];
            const panel = document.getElementById('mobile-info-panel');

            if (panel) {
                panel.innerHTML = `
                    <div class="character-info">
                        <strong>è§’è‰²ï¼š</strong>
                        <span>${char.name}</span><br>
                        <small style="color: #666;">${char.title}</small>
                    </div>

                    <h4>ğŸ“¦ èƒŒåŒ…</h4>
                        <div id="mobile-inventory">
                            ${gameState.playerInventory.length === 0 ?
                                '<div style="color: #999; font-style: italic;">èƒŒåŒ…æ˜¯ç©ºçš„</div>' :
                                gameState.playerInventory.map(item =>
                                    `<div style="padding: 8px; margin: 5px 0; background: #f5f5f5; border-radius: 5px;">${getItemDisplayName(item)}</div>`
                                ).join('')
                            }
                        </div>

                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <strong>ç¬¬ ${gameState.currentDay} å¤©</strong>
                    </div>
                `;
            }
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿
        function toggleMobileInfoPanel() {
            const panel = document.getElementById('mobile-info-panel');
            if (panel) {
                const isVisible = panel.style.display === 'block';
                if (isVisible) {
                    hideMobileInfoPanel();
                } else {
                    showMobileInfoPanel();
                }
            }
        }

        // æ˜¾ç¤ºç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿
        function showMobileInfoPanel() {
            const panel = document.getElementById('mobile-info-panel');
            const overlay = document.getElementById('mobile-overlay');

            if (panel && overlay) {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        // éšè—ç§»åŠ¨ç«¯ä¿¡æ¯é¢æ¿
        function hideMobileInfoPanel() {
            const panel = document.getElementById('mobile-info-panel');
            const overlay = document.getElementById('mobile-overlay');

            if (panel && overlay) {
                panel.style.display = 'none';
                overlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // äº‹ä»¶ç»‘å®š
        document.addEventListener('DOMContentLoaded', function() {
            loadGameState();
            // é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œé‡ç½®äº¤æ¢å®ŒæˆçŠ¶æ€ï¼Œç¡®ä¿æ¯æ¬¡è¿›å…¥äº¤æ¢é¡µé¢åªèƒ½äº¤æ¢ä¸€æ¬¡
            gameState.exchangeCompleted = false;
            showExchangePage();

            // ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶
            const mobileBtn = document.getElementById('mobile-info-btn');
            if (mobileBtn) {
                mobileBtn.addEventListener('click', toggleMobileInfoPanel);
            }

            // é®ç½©å±‚ç‚¹å‡»å…³é—­
            document.addEventListener('click', function(e) {
                if (e.target.id === 'mobile-overlay') {
                    hideMobileInfoPanel();
                }
            });

            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 27) {
                    hideMobileInfoPanel();
                }
            });
        });
    </script>
</body>
</html>