:: StoryInit
// æ¸¸æˆçŠ¶æ€
<<set $currentDay = 1>>
<<set $selectedCharacter = null>>
<<set $gameStarted = false>>

// è§’è‰²å®šä¹‰
<<set $characters = {
	"claudius": {
		name: "å…‹åŠ³ç‹„æ–¯",
		title: "å›½ç‹",
		description: "ä½ æ˜¯ä¸¹éº¦ç‹å…‹åŠ³ç‹„æ–¯ï¼Œè¿™ç‹ä½æœ¬æ˜¯ä½ å“¥å“¥çš„ã€‚ä¸€åœºé˜´è°‹è®©ä»–å‘½ä¸§é»„æ³‰ã€‚è¿™æ·±å®«é‡Œï¼Œè—ç€ä½ çš„ç§˜å¯†ï¼Œé‚£æ˜¯ä½ æœ€æ·±çš„ææƒ§ã€‚",
		initialItems: ["çš‡å† ", "çç é€šå…³ä¿¡ç‰©", "é‡‘é’±"],
		goal: "æ¯’æ­»æŒæœ‰è¯æ®çš„äºº",
		goalKey: "prevent_conspiracy",
		backstory: "ä½ çš„ç‹ä½æ¥è·¯ä¸æ­£ï¼Œè¿™å¯åƒä¸‡ä¸èƒ½è®©äººçŸ¥é“ã€‚å½“å¹´çš„çŸ¥æƒ…äººå·²ç»ä¸å¤šäº†ï¼Œä»…å‰©æœ€åä¸€ä»¶è¯æ®è¿˜æµè½æ°‘é—´ã€‚ä½ å†³å®šåˆ©ç”¨è¿™ä¸ªæ¡ˆä»¶ï¼Œå€Ÿæœºé”€æ¯è¯æ®ã€‚"
	},
	"chengying": {
		name: "ç¨‹å©´",
		title: "å¾¡åŒ»",
		description: "å¤©ä¸‹äººçš†éª‚ä½ ï¼Œå…¶å®ä½ å§è–ªå°èƒ†ï¼Œåªä¸ºæ­å¼€å½“å¹´çš„çœŸç›¸ã€‚",
		initialItems: ["ä¸­è‰è¯", "å®‰çœ è¯"],
		goal: "æ‰¾åˆ°å…ˆç‹çš„æ­»å› ",
		goalKey: "find_cure",
		backstory: "ä½œä¸ºå›½ç‹çš„å¾¡åŒ»ï¼Œä½ æ¢éçš‡å®«ä¸€æ— æ‰€è·ã€‚ä½†æ˜¯å¹´äº‹å·²é«˜ï¼Œææ€•æ—¶æ—¥ä¸å¤šäº†ã€‚æ­£å·§è¿™å›å›½ç‹ä¸‹ä»¤å½»æŸ¥ï¼Œä½ è¦è¶ç€è¿™ä¸ªæœºä¼šè§£å¼€è°œå›¢ã€‚"
	},
	"hefei": {
		name: "ä½•é",
		title: "æ½œæ°´æ•™ç»ƒ",
		description: "ä½ æ˜¯ä¸ªè´ªè´¢å¥½è‰²ä¹‹äººï¼Œå”¯åˆ©æ˜¯å›¾ä½†ä¹Ÿéäº¤æœ‹å‹ã€‚",
		initialItems: ["æ½œæ°´è£…å¤‡", "éª°å­", "ç”»å…·"],
		goal: "åœ¨ä¸‰å¤©å†…è·å–è¶³å¤Ÿçš„é’±è¿˜æ¸…èµŒå€ºã€‚",
		goalKey: "prove_identity",
		backstory: "å…‹åŠ³ç‹„æ–¯ç™»åŸºæ—¶ï¼Œå°äº†æ–°å¤´åƒçš„é’±å¸ã€‚äººäººéƒ½çŸ¥é“ï¼Œä½ æœ€å–œæ¬¢å…‹åŠ³ç‹„æ–¯çš„å¸äº†ã€‚"
	},
	"lixiang": {
		name: "ææƒ³",
		title: "ä¸‹æ°´é“å·¥ç¨‹è®¾è®¡å¸ˆ",
		description: "è´Ÿè´£çš‡å®«çš„ä¸‹æ°´é“å·¥ç¨‹è®¾è®¡ã€‚",
		initialItems: ["åœ°ä¸‹ç³»ç»Ÿè®¾è®¡å›¾"],
		goal: "æ‰¾åˆ°å°¸ä½“ä¸æ˜¯å› ä¸‹æ°´é“è®¾è®¡æœ‰é—®é¢˜é€ æˆçš„æ­»äº¡æ¡ˆä»¶ã€‚",
		goalKey: "discover_secret",
		backstory: "ä½œä¸ºä¸‹æ°´é“ç³»ç»Ÿçš„è®¾è®¡å¸ˆï¼Œè¦æ˜¯è®¾è®¡é—®é¢˜é€ æˆäº†å·¥åŒ æ­»äº¡ï¼Œé‚£å¯æ˜¯å¾ˆä¸¥é‡çš„ã€‚ä½ å¿…é¡»æ‰¾å‡ºçœŸç›¸ã€‚"
	},
	"wuzhizhe": {
		name: "å´æ™ºå“²",
		title: "å»ºç­‘è®¾è®¡å¸ˆ",
		description: "å·²æ•…çš‡å®«æ€»å»ºç­‘è®¾è®¡å¸ˆçš„å…³é—¨å¼Ÿå­ã€‚",
		initialItems: ["çš‡å®«åœ°é¢éƒ¨åˆ†è®¾è®¡å›¾", "å¯¼å¸ˆæ‰‹è®°"],
		goal: "åœ¨ä¸‰å¤©å†…æ‰¾åˆ°å¸ˆå‚…ç•™ä¸‹çš„ç§˜å¯†å¹¶ä¿æŠ¤å®ƒ",
		goalKey: "protect_secret",
		backstory: "ä½ çš„å¯¼å¸ˆåœ¨å»ä¸–å‰ç•™ä¸‹äº†ä¸€äº›é‡è¦çš„ç§˜å¯†ã€‚ä½ çŸ¥é“å®ƒä»¬å¾ˆé‡è¦ä½†å¹¶ä¸æ¸…æ¥šç»†èŠ‚ï¼Œå†³å®šä¸€æ¢çœŸç›¸ã€‚"
	},
	"wangweiguo": {
		name: "ç‹å«å›½",
		title: "æ–½å·¥è¿è¾“é˜Ÿé˜Ÿé•¿",
		description: "è´Ÿè´£æ–½å·¥è¿è¾“çš„é˜Ÿé•¿ï¼ŒæŒæ¡ç€ç‰©èµ„å’Œäººå‘˜çš„æµåŠ¨ã€‚",
		initialItems: ["çš‡å®«åœ°å›¾", "å‘¨æŠ¥"],
		goal: "æŒ‰æ—¶äº¤ä»˜çš‡å®«ä¿®å»ºå·¥ç¨‹",
		goalKey: "stop_illegal_transport",
		backstory: "ä½œä¸ºè¿è¾“é˜Ÿé˜Ÿé•¿ï¼Œä½ çš„å›¢é˜Ÿè·ç¦»äº¤ä»˜è¿˜å‰©ä¸‰å¤©ã€‚è¯·æ‰¾åˆ°ä¿®å»ºæ‰€éœ€çš„æ‰€æœ‰ææ–™ï¼Œä¿è¯çš‡å®«æŒ‰æ—¶äº¤ä»˜ã€‚"
	}
}>>

// NPCè§’è‰²ï¼ˆå…¶ä»–5ä¸ªè§’è‰²ï¼‰
<<set $npcs = []>>

// ç©å®¶è£…å¤‡
<<set $playerInventory = []>>

// æ‰€æœ‰è§’è‰²çš„å½“å‰è£…å¤‡ï¼ˆç”¨äºäº¤æ¢ï¼‰
<<set $allCharactersItems = {}>>

// ç›®æ ‡å®ŒæˆçŠ¶æ€
<<set $goalCompleted = false>>

// å·²äº¤æ¢è£…å¤‡çš„è®°å½•ï¼ˆæ¯å¤©åªèƒ½äº¤æ¢ä¸€æ¬¡ï¼‰
<<set $exchangedToday = false>>
<<set $exchangeHistory = []>>

// åˆå§‹åŒ–ä¾§è¾¹æ ç³»ç»Ÿ
<<script>>
(function() {
	'use strict';
	
	// åˆ›å»ºä¾§è¾¹æ å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
	function createSidebar() {
		var sidebar = document.getElementById('game-sidebar');
		if (!sidebar) {
			sidebar = document.createElement('div');
			sidebar.id = 'game-sidebar';
			document.body.appendChild(sidebar);
		}
		return sidebar;
	}
	
	// æ›´æ–°ä¾§è¾¹æ çš„å‡½æ•°
	function updateSidebar() {
		var sidebar = createSidebar();
		
		// æ£€æŸ¥æ¸¸æˆçŠ¶æ€
		if (typeof State === 'undefined' || !State.variables) {
			sidebar.style.display = 'none';
			return;
		}
		
		// æ£€æŸ¥å½“å‰passage
		var currentPassage = '';
		try {
			currentPassage = Story.get('passage').title;
		} catch (e) {
			sidebar.style.display = 'none';
			return;
		}
		
		var hideSidebar = currentPassage === 'CharacterSelect' || 
		                  currentPassage === 'About' || 
		                  (currentPassage && currentPassage.indexOf('CharacterClaudius') === 0) ||
		                  (currentPassage && currentPassage.indexOf('CharacterChengying') === 0) ||
		                  (currentPassage && currentPassage.indexOf('CharacterHefei') === 0) ||
		                  (currentPassage && currentPassage.indexOf('CharacterLixiang') === 0) ||
		                  (currentPassage && currentPassage.indexOf('CharacterWuzhizhe') === 0) ||
		                  (currentPassage && currentPassage.indexOf('CharacterWangweiguo') === 0) ||
		                  (currentPassage && currentPassage.indexOf('ConfirmCharacter') === 0) ||
		                  !State.variables.gameStarted || 
		                  !State.variables.selectedCharacter;
		
		if (hideSidebar) {
			sidebar.style.display = 'none';
			var passages = document.querySelectorAll('.passage');
			passages.forEach(function(p) {
				p.style.marginLeft = 'auto';
			});
			return;
		}
		
		// æ˜¾ç¤ºä¾§è¾¹æ å¹¶æ›´æ–°å†…å®¹
		try {
			var char = State.variables.characters[State.variables.selectedCharacter];
			var inventory = State.variables.playerInventory || [];
			var currentDay = State.variables.currentDay || 1;
			
			var html = '<div class="character-info">';
			html += '<strong>è§’è‰²ï¼š</strong>';
			html += '<span>' + char.name + '</span><br>';
			html += '<small style="color: #666;">' + char.title + '</small>';
			html += '</div>';
			
			html += '<h3>ğŸ“¦ èƒŒåŒ…</h3>';
			html += '<div id="inventory-display">';
			if (inventory.length === 0) {
				html += '<div class="inventory-empty">èƒŒåŒ…æ˜¯ç©ºçš„</div>';
			} else {
				for (var i = 0; i < inventory.length; i++) {
					html += '<div class="inventory-item">' + inventory[i] + '</div>';
				}
			}
			html += '</div>';
			
			html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">';
			html += '<strong>ç¬¬ ' + currentDay + ' å¤©</strong>';
			html += '</div>';
			
			sidebar.innerHTML = html;
			sidebar.style.display = 'block';
			
			var passages = document.querySelectorAll('.passage');
			passages.forEach(function(p) {
				p.style.marginLeft = '220px';
			});
		} catch (e) {
			sidebar.style.display = 'none';
		}
	}
	
	// ç­‰å¾…DOMå’ŒSugarCubeåŠ è½½å®Œæˆ
	$(document).one(':storyready', function() {
		createSidebar();
		setTimeout(updateSidebar, 100);
		
		// ç›‘å¬passageæ¸²æŸ“äº‹ä»¶
		$(document).on(':passagerender', function() {
			setTimeout(updateSidebar, 10);
		});
		
		$(document).on(':passagedisplay', function() {
			setTimeout(updateSidebar, 10);
		});
	});
	
	// ä¹Ÿç›‘å¬DOM readyäº‹ä»¶ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
	$(document).ready(function() {
		setTimeout(function() {
			createSidebar();
			updateSidebar();
		}, 200);
	});
})();
<</script>>

:: StoryCaption
<h1>å¥‡ç¼˜è§’è‰²</h1>

:: StoryMenu
<<if $gameStarted>>
	[[ç»§ç»­æ¸¸æˆ|DayStart]]
<<else>>
	[[å¼€å§‹æ¸¸æˆ|CharacterSelect]]
<</if>>
[[å…³äº|About]]

:: UpdateSidebar
<<script>>
	(function() {
		// åˆ›å»ºæˆ–æ›´æ–°ä¾§è¾¹æ 
		var sidebar = document.getElementById('game-sidebar');
		if (!sidebar) {
			sidebar = document.createElement('div');
			sidebar.id = 'game-sidebar';
			sidebar.className = 'collapsed'; // é»˜è®¤æŠ˜å çŠ¶æ€
			document.body.appendChild(sidebar);

			// æ·»åŠ åˆ‡æ¢æŒ‰é’®
			var toggleBtn = document.createElement('button');
			toggleBtn.className = 'sidebar-toggle';
			toggleBtn.innerHTML = 'ğŸ“¦';
			toggleBtn.title = 'åˆ‡æ¢èƒŒåŒ…æ˜¾ç¤º';
			toggleBtn.onclick = function() {
				sidebar.classList.toggle('collapsed');
				// ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
				var isCollapsed = sidebar.classList.contains('collapsed');
				localStorage.setItem('sidebarCollapsed', isCollapsed);
			};
			sidebar.appendChild(toggleBtn);

			// ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
			var savedCollapsed = localStorage.getItem('sidebarCollapsed');
			if (savedCollapsed === 'false') {
				sidebar.classList.remove('collapsed');
			}
		}

		// æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¼€å§‹
		if (State.variables.gameStarted && State.variables.selectedCharacter) {
			// æ›´æ–°ä¾§è¾¹æ å†…å®¹
			var char = State.variables.characters[State.variables.selectedCharacter];
			var charName = char.name;
			var charTitle = char.title;
			var inventory = State.variables.playerInventory || [];
			var currentDay = State.variables.currentDay || 1;

			var html = '<div class="sidebar-content">';

			html += '<div class="character-info">';
			html += '<strong>è§’è‰²ï¼š</strong>';
			html += '<span>' + charName + '</span><br>';
			html += '<small style="color: #666;">' + charTitle + '</small>';
			html += '</div>';

			html += '<h3>ğŸ“¦ èƒŒåŒ…</h3>';
			html += '<div id="inventory-display">';
			if (inventory.length === 0) {
				html += '<div class="inventory-empty">èƒŒåŒ…æ˜¯ç©ºçš„</div>';
			} else {
				for (var i = 0; i < inventory.length; i++) {
					html += '<div class="inventory-item">' + inventory[i] + '</div>';
				}
			}
			html += '</div>';

			html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">';
			html += '<strong>ç¬¬ ' + currentDay + ' å¤©</strong>';
			html += '</div>';

			html += '</div>';

			// æ›´æ–°å†…å®¹ï¼ˆä¿ç•™åˆ‡æ¢æŒ‰é’®ï¼‰
			var contentDiv = sidebar.querySelector('.sidebar-content');
			if (contentDiv) {
				contentDiv.innerHTML = html.slice(22, -7); // ç§»é™¤<div class="sidebar-content">åŒ…è£…
			} else {
				sidebar.insertAdjacentHTML('beforeend', html);
			}

			sidebar.style.display = 'block';
		} else {
			// éšè—ä¾§è¾¹æ 
			sidebar.style.display = 'none';
		}
	})();
<</script>>

:: StoryInterface
<div id="passages"></div>
